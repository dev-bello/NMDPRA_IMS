{% extends "reports/base.html" %}

{% block title %}Inventory Report - NMDPRA{% endblock %}

{% block content %}
<!-- Bootstrap CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Flatpickr monthSelect plugin -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

<!-- Tom Select CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<div class="report-container">
    <!-- NMDPRA Logo for PDF/Print -->
    <div style="text-align:center; margin-bottom: 1.5rem;">
        <img src="{{ url_for('static', filename='images/logo/nmdpra-logo.png') }}" alt="NMDPRA Logo" style="max-height:80px;">
    </div>

    <h2 style="text-align:center;">Inventory Report</h2>
    <div style="text-align:center; margin-bottom: 1rem;">
        <strong>Period:</strong> {{ meta.start_date or '—' }} to {{ meta.end_date or '—' }}<br>
        <strong>Generated by:</strong> {{ meta.generated_by or '—' }}<br>
        <strong>Generated at:</strong> {{ meta.generated_at or '—' }}
    </div>

    <div class="d-flex gap-3 mb-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reportModal">Generate Report</button>
        
        <!-- Download Excel Button -->
        {% if report_data %}
        <a href="{{ url_for('reports.download_excel_report', report_id=report_id) }}" class="btn btn-success ms-auto">
            Download Excel
        </a>
        {% endif %}
    </div>

    <!-- Unified Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="post" action="{{ url_for('reports.inventory_report') }}" id="report_form">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reportModalLabel">Generate Inventory Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Report Type Selector -->
                        <div class="mb-3">
                            <label for="report_type_selector" class="form-label">Report Period</label>
                            <select id="report_type_selector" name="report_type" class="form-select" required>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>

                        <!-- Conditional Fields -->
                        <div id="weekly_fields" class="conditional_fields">
                            <label for="week_range" class="form-label">Date Range</label>
                            <input type="text" id="week_range" name="week_range" class="form-control" placeholder="Select week range" autocomplete="off">
                        </div>
                        <div id="monthly_fields" class="conditional_fields">
                            <label for="month" class="form-label">Month</label>
                            <input type="text" id="month" name="month" class="form-control" placeholder="Select month" autocomplete="off">
                        </div>
                        <div id="quarterly_fields" class="conditional_fields">
                            <div class="row">
                                <div class="col">
                                    <label for="quarter_year" class="form-label">Year</label>
                                    <input type="number" id="quarter_year" name="year" class="form-control" placeholder="YYYY" value="{{ now.year }}" required>
                                </div>
                                <div class="col">
                                    <label for="quarter" class="form-label">Quarter</label>
                                    <select id="quarter" name="quarter" class="form-select">
                                        <option value="1">Q1</option>
                                        <option value="2">Q2</option>
                                        <option value="3">Q3</option>
                                        <option value="4">Q4</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="yearly_fields" class="conditional_fields">
                            <label for="year" class="form-label">Year</label>
                            <input type="number" id="year" name="year" class="form-control" placeholder="YYYY" value="{{ now.year }}" required>
                        </div>

                        <!-- Common Filters -->
                        <div class="mb-3 mt-3">
                            <label for="category_id" class="form-label">Category</label>
                            <select id="category_id" name="category_id" class="form-select">
                                <option value="">All</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="item_id" class="form-label">Item</label>
                            <select id="item_id" name="item_id" class="form-select">
                                <option value="">All</option>
                                {% for item in items %}
                                    <option value="{{ item.id }}">{{ item.item_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <select id="location" name="location" class="form-select">
                                <option value="">All</option>
                                {% for loc in locations %}
                                    <option value="{{ loc }}">{{ loc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Generate Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if report_data %}
        {% for category, items in report_data.items() %}
            <h3 style="margin-top:2rem; font-weight:bold;">{{ category }}</h3>
            <div class="inventory-list">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Description</th>
                            <th>Opening Stock</th>
                            <th>Purchases</th>
                            <th>Adjustment</th>
                            <th>HQ Issue</th>
                            <th>Jabi Issue</th>
                            <th>Closing Stock</th>
                            <th>Unit Price (₦)</th>
                            <th>Total Value (₦)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in items %}
                        <tr>
                            <td>{{ row.item_name }}</td>
                            <td>{{ row.description or 'N/A' }}</td>
                            <td>{{ row.opening_stock }}</td>
                            <td>{{ row.purchases }}</td>
                            <td>{{ row.adjustments }}</td>
                            <td>{{ row.hq_issues }}</td>
                            <td>{{ row.jabi_issues }}</td>
                            <td>{{ row.closing_stock }}</td>
                            <td>{{ "{:,.2f}".format(row.unit_price|float) }}</td>
                            <td>{{ "{:,.2f}".format(row.total_value|float) }}</td>
                        </tr>
                        {% endfor %}
                        <!-- Category Totals Row -->
                        <tr style="font-weight:bold; background:#f8f9fa;">
                            <td colspan="2">Total for {{ category }}</td>
                            <td>{{ category_totals[category].opening_stock }}</td>
                            <td>{{ category_totals[category].purchases }}</td>
                            <td>{{ category_totals[category].adjustments }}</td>
                            <td>{{ category_totals[category].hq_issues }}</td>
                            <td>{{ category_totals[category].jabi_issues }}</td>
                            <td>{{ category_totals[category].closing_stock }}</td>
                            <td></td>
                            <td>{{ "{:,.2f}".format(category_totals[category].total_value|float) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        {% endfor %}

        <!-- Grand Totals -->
        <div class="inventory-list" style="margin-top:2rem;">
            <table class="inventory-table">
                <thead>
                    <tr style="background:#e0e0e0;">
                        <th colspan="2">Grand Total</th>
                        <th>Opening Stock</th>
                        <th>Purchases</th>
                        <th>Adjustment</th>
                        <th>HQ Issue</th>
                        <th>Jabi Issue</th>
                        <th>Closing Stock</th>
                        <th></th>
                        <th>Total Value (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="font-weight:bold;">
                        <td colspan="2"></td>
                        <td>{{ grand_totals.opening_stock }}</td>
                        <td>{{ grand_totals.purchases }}</td>
                        <td>{{ grand_totals.adjustments }}</td>
                        <td>{{ grand_totals.hq_issues }}</td>
                        <td>{{ grand_totals.jabi_issues }}</td>
                        <td>{{ grand_totals.closing_stock }}</td>
                        <td></td>
                        <td>{{ "{:,.2f}".format(grand_totals.total_value|float) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endif %}

    <!-- Display this section only if there is no report data -->
    {% if not report_data %}
        <div class="messages info" style="margin-top:2rem;">
            No report data available for the period '{{ meta.start_date }}' to '{{ meta.end_date }}' with the selected filters. Please select a different date range or adjust your filters.
        </div>
        <!-- Always show the table structure even if no data -->
        <div class="inventory-list" style="margin-top:2rem;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Description</th>
                        <th>Opening Stock</th>
                        <th>Purchases</th>
                        <th>Adjustment</th>
                        <th>HQ Issue</th>
                        <th>Jabi Issue</th>
                        <th>Closing Stock</th>
                        <th>Unit Price (₦)</th>
                        <th>Total Value (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="10" style="text-align:center; color:#888;">No data for the selected filter.</td></tr>
                </tbody>
            </table>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Flatpickr for date pickers
    flatpickr("#week_range", {
        mode: "range",
        dateFormat: "Y-m-d"
    });

    flatpickr("#month", {
        plugins: [
            new monthSelectPlugin({
                shorthand: true,
                dateFormat: "Y-m",
                altFormat: "F Y"
            })
        ],
    });

    // Initialize TomSelect for item search
    new TomSelect('#item_id', {
        valueField: 'id',
        labelField: 'text',
        searchField: 'text',
        load: function(query, callback) {
            var url = '{{ url_for("reports.search_inventory") }}?q=' + encodeURIComponent(query);
            fetch(url)
                .then(response => response.json())
                .then(json => {
                    callback(json);
                }).catch(()=>{
                    callback();
                });
        },
        render: {
            option: function(data, escape) {
                return '<div>' + escape(data.text) + '</div>';
            },
            item: function(data, escape) {
                return '<div>' + escape(data.text) + '</div>';
            }
        }
    });

    // Handle conditional field display and input disabling
    const reportTypeSelector = document.getElementById('report_type_selector');
    const fieldGroups = {
        weekly: document.getElementById('weekly_fields'),
        monthly: document.getElementById('monthly_fields'),
        quarterly: document.getElementById('quarterly_fields'),
        yearly: document.getElementById('yearly_fields')
    };

    function setRequired(elements, required) {
        elements.forEach(el => el.required = required);
    }

    reportTypeSelector.addEventListener('change', function() {
        const selectedType = this.value;

        // Loop through all field groups
        for (const type in fieldGroups) {
            const group = fieldGroups[type];
            const inputs = group.querySelectorAll('input, select');
            
            if (type === selectedType) {
                // Show and enable the selected group's inputs
                group.style.display = 'block';
                inputs.forEach(input => input.disabled = false);
                // Set required attribute for the visible inputs
                if (type === 'weekly') setRequired([group.querySelector('#week_range')], true);
                if (type === 'monthly') setRequired([group.querySelector('#month')], true);
                if (type === 'quarterly') setRequired([group.querySelector('#quarter_year'), group.querySelector('#quarter')], true);
                if (type === 'yearly') setRequired([group.querySelector('#year')], true);

            } else {
                // Hide and disable the other groups' inputs
                group.style.display = 'none';
                inputs.forEach(input => input.disabled = true);
                // Remove required attribute from hidden inputs
                setRequired(Array.from(inputs), false);
            }
        }
    });

    // Trigger the change event on page load to set the initial state
    reportTypeSelector.dispatchEvent(new Event('change'));

    // Handle form submission loading state
    const form = document.getElementById('report_form');
    const submitButton = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', function() {
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
    });
});
</script>
{% endblock %}
